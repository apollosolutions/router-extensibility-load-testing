version: 3

includes:
  shared:
    taskfile: ./Taskfile.Shared.yml
    internal: true

tasks:
  baseline:
    cmds:
      - task: shared:loadtest
        vars:
          RESULTS_NAME: baseline
          ROUTER_CONFIG: router/router_baseline.yaml
  config:
    cmds:
      - task: shared:loadtest
        vars:
          RESULTS_NAME: config
          ROUTER_CONFIG: tests/{{.TEST_NAME}}/router_config.yaml
  go:
    cmds:
      - task: shared:setup-go
      - defer:
          task: shared:cleanup-go
      - task: shared:loadtest
        vars:
          RESULTS_NAME: go
          ROUTER_CONFIG: tests/{{.TEST_NAME}}/router_co.yaml
  node:
    cmds:
      - task: shared:setup-node
      - defer:
          task: shared:cleanup-node
      - task: shared:loadtest
        vars:
          RESULTS_NAME: node
          ROUTER_CONFIG: tests/{{.TEST_NAME}}/router_co.yaml
  rhai:
    cmds:
      - task: shared:loadtest
        vars:
          RESULTS_NAME: rhai
          ROUTER_CONFIG: tests/{{.TEST_NAME}}/router_rh.yaml
          ROUTER_RUN_OPTIONS: --mount "type=bind,source=$PWD/tests/{{.TEST_NAME}}/rhai,target=/dist/config/rhai"
  local-subgraphs:
    cmds:
      - task: shared:setup-subgraph-a
      - defer:
          task: shared:cleanup-subgraph-a
      - task: shared:setup-subgraph-b
      - defer:
          task: shared:cleanup-subgraph-b
      - task: shared:loadtest-local-go
        vars:
          RESULTS_NAME: local
          ROUTER_CONFIG: tests/{{.TEST_NAME}}/router_co.yaml
          ROUTER_RUN_OPTIONS: --mount "type=bind,source=$PWD/subgraphs/composed-schmea.graphql,target=/dist/schema/local.graphql"
