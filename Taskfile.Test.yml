version: 3

includes:
  shared:
    taskfile: ./Taskfile.Shared.yml
    internal: true

tasks:
  baseline:
    cmds:
      - task: shared:loadtest
        vars:
          NAME: baseline
          ROUTER_CONFIG: router/router_baseline.yaml
  config:
    cmds:
      - task: shared:loadtest
        vars:
          NAME: config
          ROUTER_CONFIG: tests/{{.TEST_NAME}}/router_config.yaml
  go:
    cmds:
      - task: shared:loadtest-coprocessor
        vars:
          NAME: go
  node:
    cmds:
      - task: shared:loadtest-coprocessor
        vars:
          NAME: node
  csharp:
    cmds:
      - task: shared:loadtest-coprocessor
        vars:
          NAME: csharp
  java:
    cmds:
      - task: shared:loadtest-coprocessor
        vars:
          NAME: java
  rhai:
    cmds:
      - task: shared:loadtest
        vars:
          NAME: rhai
          ROUTER_CONFIG: tests/{{.TEST_NAME}}/router_rh.yaml
          ROUTER_RUN_OPTIONS: --mount "type=bind,source=$PWD/tests/{{.TEST_NAME}}/rhai,target=/dist/config/rhai"
  local-subgraphs:
    cmds:
      - task: shared:setup-subgraph-a
      - defer:
          task: shared:cleanup-subgraph-a
      - task: shared:setup-subgraph-b
      - defer:
          task: shared:cleanup-subgraph-b
      - task: shared:loadtest-local-go
        vars:
          RESULTS_NAME: local
          ROUTER_CONFIG: tests/{{.TEST_NAME}}/router_co.yaml
          ROUTER_RUN_OPTIONS: --mount "type=bind,source=$PWD/subgraphs/composed-schmea.graphql,target=/dist/schema/local.graphql"
