version: "3"

includes:
  shared:
    taskfile: ./Shared.yml

tasks:
  report:
    dir: tests/static-subgraph/results
    cmds:
      - vegeta report results_config.bin > results_config.txt
      - vegeta report results_go.bin > results_go.txt
      - vegeta report results_rhai.bin > results_rhai.txt
  test:
    cmds:
      - task: config
      - task: go
      - task: rhai
      - task: report
  config:
    cmds:
      - docker run -p 4040:4040 -d --name router --env APOLLO_GRAPH_REF="$APOLLO_GRAPH_REF" --env APOLLO_KEY="$APOLLO_KEY" --mount "type=bind,source=$PWD/tests/static-subgraph/router_config.yaml,target=/dist/config/router.yaml"  --mount "type=bind,source=$PWD/router/supergraph.graphql,target=/dist/config/supergraph.graphql" -m 1g --cpus=.3 ghcr.io/apollographql/router:v1.18.0 -s /dist/config/supergraph.graphql
      - cat loadtest/targets.txt | vegeta attack -header 'content-type:application/json' -duration=30s -rate=100 -name=config > tests/static-subgraph/results/results_config.bin
      - docker stop router
      - docker rm router
  go:
    deps: [shared:setup-go]
    cmds:
      - docker run -p 4040:4040 -d --name router --env APOLLO_GRAPH_REF="$APOLLO_GRAPH_REF" --env APOLLO_KEY="$APOLLO_KEY" --mount "type=bind,source=$PWD/tests/static-subgraph/router_co.yaml,target=/dist/config/router.yaml"  --mount "type=bind,source=$PWD/router/supergraph.graphql,target=/dist/config/supergraph.graphql" -m 1g --cpus=.3 ghcr.io/apollographql/router:v1.18.0 -s /dist/config/supergraph.graphql
      - cat loadtest/targets.txt | vegeta attack -header 'content-type:application/json' -duration=30s -rate=100 -name=go > tests/static-subgraph/results/results_go.bin
      - docker stop router
      - docker rm router
      - task: shared:cleanup-go
  rhai:
    cmds:
      - docker run -p 4040:4040 -d --name router --env APOLLO_GRAPH_REF="$APOLLO_GRAPH_REF" --env APOLLO_KEY="$APOLLO_KEY" --mount "type=bind,source=$PWD/tests/static-subgraph/router_rh.yaml,target=/dist/config/router.yaml"  --mount "type=bind,source=$PWD/router/supergraph.graphql,target=/dist/config/supergraph.graphql" --mount "type=bind,source=$PWD/tests/static-subgraph/rhai,target=/dist/config/rhai" -m 1g --cpus=.3 ghcr.io/apollographql/router:v1.18.0 -s /dist/config/supergraph.graphql
      - cat loadtest/targets.txt | vegeta attack -header 'content-type:application/json' -duration=30s -rate=100 -name=rhai> tests/static-subgraph/results/results_rhai.bin
      - docker stop router
      - docker rm router
